// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ðŸ¤– DM REALM ALPHA â€” AI MICROSERVICE
// Versione 2.0 â€“ Compatibile Node.js v22 / Express 4.19
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

import express from "express";
import bodyParser from "body-parser";
import dotenv from "dotenv";
dotenv.config();

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// âš™ï¸ CONFIGURAZIONE DI BASE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const app = express();
app.use(bodyParser.json());

const PORT = process.env.AI_PORT || 4000;

// Messaggio di avvio
console.log("ðŸ§  Inizializzazione microservizio DM ALPHA AI...");
console.log("â³ Caricamento modelli ibridi...");

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ðŸ“š DATABASE RISPOSTE STATICHE (SCRIPT BASE)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import fs from "fs";
import path from "path";

const scriptPath = path.resolve("src/ai/scripts.json");
let scripts = {};

try {
  scripts = JSON.parse(fs.readFileSync(scriptPath, "utf-8"));
  console.log(`ðŸ“œ Script AI caricati (${Object.keys(scripts).length} categorie)`);
} catch (err) {
  console.warn("âš ï¸ Nessun file scripts.json trovato o errore di parsing.");
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ðŸ§© FUNZIONE RISPOSTA AI IBRIDA
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function generateResponse(question, context = "") {
  const q = question.toLowerCase();

  // 1ï¸âƒ£ Risposte definite nello script.json
  for (const key in scripts) {
    if (q.includes(key.toLowerCase())) {
      const possible = scripts[key];
      const random = possible[Math.floor(Math.random() * possible.length)];
      return random;
    }
  }

  // 2ï¸âƒ£ Risposte predefinite per fallback
  if (q.includes("ai") || q.includes("assistente")) {
    return "ðŸ§  Sono lâ€™assistente DM ALPHA, posso segnalare, analizzare o creare log. Come posso aiutarti?";
  }
  if (q.includes("ticket") || q.includes("problema")) {
    return "ðŸ“© Sembra che tu stia parlando di un ticket. Posso aiutarti ad aprirne uno o a contattare lo staff.";
  }

  // 3ï¸âƒ£ Fallback finale
  return "ðŸ¤– Non ho informazioni specifiche su questo argomento, ma il mio sistema di log lo inoltrerÃ  allo staff per analisi.";
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ðŸ”— ENDPOINT API â€” /respond
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app.post("/respond", async (req, res) => {
  try {
    const { question, context } = req.body;

    if (!question || question.trim().length === 0) {
      return res.status(400).json({ error: "Richiesta non valida: 'question' mancante." });
    }

    const reply = generateResponse(question, context);
    res.json({ reply, model: "DM-ALPHA-Local" });
  } catch (err) {
    console.error("âŒ Errore durante la risposta AI:", err.message);
    res.status(500).json({ error: "Errore interno AI" });
  }
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ðŸ§ª ENDPOINT DI TEST â€” GET /ping
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app.get("/ping", (req, res) => {
  res.json({ status: "online", service: "DM-ALPHA-AI", timestamp: Date.now() });
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ðŸš€ AVVIO SERVER
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app.listen(PORT, "0.0.0.0", () => {
  console.log(`ðŸ¤– DM ALPHA AI Microservice attivo sulla porta ${PORT}`);
  console.log("âœ… Pronto per ricevere richieste su /respond e /ping");
});
